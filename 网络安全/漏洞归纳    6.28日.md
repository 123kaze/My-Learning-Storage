# 漏洞归纳

## 1.文件上传漏洞

​    常用的文件上传功能：上传一张自定义的图片；分享一段视频或者照片；论坛发帖时附带一个附件；在发送 邮件时附带附件等，上传之后执行脚本，得到管理员权限等。

上传文件是 Web 脚本语言，服务器的 Web 容器解释并执行了用户上传的脚本，导致代码执行；

上传文件是 Flash 的策略文件 crossdo-main.xml ，黑客用以控制 Flash 在该域下的行为（其他通过类似 方式控制策略文件的情况类似）；

上传文件是病毒、木马文件，黑客用以诱骗用户或者管理员下载执行；

上传文件是钓鱼图片或为包含了脚本的图片，在某些版本的浏览器中会被作为脚本执行，被用于钓鱼和欺诈

### 1.1**FCKEditor** 文件上传漏洞

​        FCKEditor 是一款非常流行的富文本编辑器，为了方便用户，它带有一个上传文件功能。 **http:// [www.xxx.com/path/FCKeditor/editor/filemanager/browser/default/browser.html?](http://www.xxx.com/path/FCKeditor/editor/filemanager/browser/default/browser.html)Type=all&Connector=connectors/php/connec**

打开这个页面，就可以向后端发文件，在/User-Files/all/ 目录下。

有些为了修，加入了黑名单，

![image-20250628120756295](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628120756295.png)

**原理及修改建议：由于 FCKEditor 一般是作为第三方应用集成到网站中的，因此文件上传的目录一般默认都会被 Web 容器所解析，很容易形成文件上传漏洞。很多开发者在使用 FCKEditor 时，可能都不知道它 存在一个文件上传功能，如果不是特别需要，建议删除 FCKEditor 的文件上传代码，一般情况下也 用不到它。**

### 1.2绕过文件上传检查功能

​       **网页是前端校验还是后端校验？前端校验等于没有。**（看刷新转不转）

- 很多都是通过检测后缀来检查上传文件的，在文件名后添加一个 %00 字节，则可以截断某些函 数对文件名的判断。因为在许多语言的函数中，比如在 C 、 PHP 等语言的常用字符串处理函数中， 0x00 被认为是终止符。**比如应用原本只允许上传 JPG 图片，那么可以构造文件名（需要修改POST 包）为 xxx.php[\0].JPG ，其中 [\0] 为十六进制的 0x00 字符， .JPG 绕过了应用的上 传文件类型判断；但对于服务器端来说，此文件因为 0 字节截断的关系，最终却会变成 xxx.php 。**就可以运行且黑进去**同理，这个办法也可以广泛应用。**

- 右键，点检查，有一个齿轮图标，往下滑，下面有一个停用JS，把他打开，再点击上传即可。禁用js禁掉判断机制。或者直接删除checkfile函数。

- 有些通过文件头进行检验，有的应用，还会通过判断上传文件的文件头来验证文件的类型。 比如一个 JPG 文件，其文件头是：![image-20250628122302580](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628122302580.png)

  在**正常情况下，通过判断前 10 个字节，基本 上就能判断出一个文件的真实类型。浏览器的**

  [^[MIME\]]: 是一种描述消息类型的互联网标准。用来表示文档，文件或字节流的性质和格式

  **功能实际上也是通过读取文件的前 256 个字节，来判断文件的类型的。**所以，为了绕过，我们为了绕过应用中类似 MIME Sniff 的功能，常见的攻击技巧是伪造一个合法的文件头，而将真实的 PHP 等 脚本代码附在合法的文件头之后，比如：![image-20250628122408473](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628122408473.png)但此时，仍需要通过 PHP 来解释此图片 文件才行。所有就可以运行黑。

- 同理，在抓包里面，改掉content-type为image/png，也可以上传。

### 1.2功能还是漏洞？

#### 1.2.1缺陷：

- **Apache** 文件解析问题**Apache 对于文件名的解析是从后往前解析的，直到遇见一个 Apache 认识的文件类型为止。比如：****Phpshell.php.rar.rar.rar.rar.rar 。因为Apache 不认识 .rar 这个文件类型，所以会一直遍历后缀到****.php ，然后认为这是一个 PHP 类型的文件。**这样就可以绕过，利用信息差，运行php。

- **IIS** 文件解析问题：1.**当文件名为 abc.asp;xx.jpg 时， IIS 6 会将此文件解析为 abc.asp ，文件名被截断了，从而导致脚本被执行，类似前文提到的0x00截断，它的截断为“；”分号**

  2.——因为处理文件夹扩展名出错，导致将 /*.asp/ 目录下的 所有文件都作为 ASP 文件进行解析。比如： http://www.target.com/path/xyz.asp/abc.jpg[ ](http://www.target.com/path/xyz.asp/abc.jpg)，这个 abc.jpg ，会被当做 ASP 文件进行解析。

  但是这两个IIS都必须在本地才能触发，网站URl不会触发。

- **利用上传文件钓鱼**：钓鱼者会先将包含了 HTML 的文件（比如一张图片）上传到目标网站，然后通过传

  播这个文件的 URL 进行钓鱼，则 URL 中不会出现钓鱼地址，更具有欺骗性。比如下面这张图片： http://tech.simba.taobao.com/wp-content/uploads/2011/02/item.jpg? ](http://tech.simba.taobao.com/wp-content/uploads/2011/02/item.jpg) 1_117 ，它的实际内容是 :

  ![image-20250628125132836](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628125132836.png)里面png是个假的伪装的头，如果被执行，将 控制浏览器跳向指定的网站，在此是一个钓鱼网站。

  ***小技巧，双写****：：$DATA->::$D::$DATAATA,删掉但仍是：：$DATA

### 1.3.安全的上传文件

文件上传功能本身并没错，只是在一些条件下会被攻击者利用，从而成为漏洞。根据攻击的原理，结合实 际经验总结了以下几点：

- **判断文件类型**

  在判断文件类型时，可以结合使用 MIMEType 、后缀检查等方式。在文件类型检查中，强烈推荐白名单 的方式，黑名单的方式已经无数次被证明是不可靠的。此外，对于图片的处理，可以使用压缩函数或者 resize 函数，在处理图片的同时破坏图片中可能包含的 HTML 代码。

- **使用随机数改写文件名和文件路径**

  文件上传如果要执行代码，则需要用户能够访问到这个文件。在某些环境中，用户能上传，但不能访问。 如果应用使用随机数改写了文件名和路径，将极大地增加攻击的成本。与此同时，像 shell.php.rar.rar 这种文件，或者是 crossdo-main.xml 这种文件，都将因为文件名被改写而无法成功实施攻击。

- **单独设置文件服务器的域名**

  由于浏览器同源策略的关系，一系列客户端攻击将失效，比如上传 crossdomain.xml 、上传包含 JavaScript 的XSS 利用等问题将得到解决。但能否如此设置，还需要看具体的业务环境。

  (不太懂)

  

  **只有同源的脚本才能互相访问数据**。

  - **同源** = 相同协议（HTTP/HTTPS） + 相同域名 + 相同端口。
  - **不同源** = 跨域，浏览器会限制 JS 访问（如读取 iframe 内容、发送 AJAX 请求）。

  

  文件上传问题，看似简单，但要实现一个安全的上传功能，殊为不易。如果还要考虑到病毒、木马、色情 图片与视频、反动政治文件等与具体业务结合更紧密的问题，则需要做的工作就更多了。不断地发现问题结合业务需求，才能设计出最合理、最安全的上传功能.







## 2.未授权访问漏洞

- 了解权限控制的方法

- 掌握常见问非授权访问漏洞

- 掌握水平越权与垂直越权的成因与利用方法

- 掌握水平越权与垂直越权修复方法

### 2.1 越权操作

​	越权操作是信息系统中较为常见的一种漏洞，指的是信息系统对用户的操作 权限审核不严，从而使得用户进行了自己权限之外的操作。（有些功能没有做健全，可以直接调用。）在正常情况下，管理后台的页面应该只有管理员才能够访问。但这些系统未 对用户访问权限进行控制，导致任意用户只要构造出了正确的URL，就能够 访问到这些页面 。

权限控制方式：

- 防火墙ACL策略： 主体-规则-客体

- Linux文件权限：主体-读、写、执行-客体

- Web应用权限：基于URL、基于方法、基于数据

- RBAC： Web应用系统常采用此模型

- **RBAC 的核心组成**

  | 组件                   | 说明                                                         |
  | :--------------------- | :----------------------------------------------------------- |
  | **用户（User）**       | 系统的使用者（如管理员、普通用户）。                         |
  | **角色（Role）**       | 权限的集合（如 `admin`、`editor`、`guest`），代表一类用户的职能。 |
  | **权限（Permission）** | 具体的操作或资源访问权限（如 `delete_user`、`view_dashboard`）。 |
  | **分配（Assignment）** | 将角色赋予用户，或为角色分配权限。                           |

**目前主要存在未授权访问漏洞的有：**

NFS服务，Samba服务，LDAP，Rsync，FTP，GitLab，Jenkins，MongoDB， Redis，ZooKeeper，ElasticSearch，Memcache，CouchDB，Docker，Solr， Hadoop，Dubbo等。

解决方案：

- **隐藏：**只能阻止用户无法猜测到后台界面，爆破工具可以扫描大量后台地址

- **页面权限控制：**可以阻挡非认证用户登录后台，即使找到后台链接，也会被认 证窗口阻挡

测试方法：（第三方组件可以扫出来）

- Google-Hacking

- 域名爆破

- 端口服务扫描

- 域名关联

#### 2.1.1 案例

Swagger Api 接口未授权：Swagger是一个广泛使用的框架，用于生成、描述、调用和可视化RESTful风格的Web服务。它的一个关键特性是能够自动生成API文档，这对于开发者来说是一个极大的便利。然而，如果Swagger的API文档未经适当保护，就可能存在未授权访问的安全漏洞。



--------------------------------------------------------------

**Swagger 未授权访存在大量默认地址可以未授权访问：**

/api

/api-docs

/api-docs/swagger.json

/api.html

/api/api-docs

/api/apidocs

/api/doc

/api/swagger

/api/swagger-ui

/api/swagger-ui.html

-------------------------------------------------------------------------------------------------------------------------



**Redis简介：**

Redis 是完全开源免费的，遵守BSD协议，是一个高性能的key-value数据库。



**Redis 与其他 key - value 缓存产品有以下三个特点：**

- Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再 次加载进行使用

- Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储

- Redis支持数据的备份，即master-slave模式的数据备份。

**怎么做：**

- 扫描默认6379端口

- 直接读取数据库中的数据

- 向Web目录中写shell：需要猜到Web目录地址

- 向/root/.ssh/目录中写公钥：需要root权限

- 向crontabs中写计划任务，并**反弹shell**，需要root权限

安装环境：

- 注意点1：开放防火墙端口firewall-cmd --add-port=6379/tcp --permanent使防火墙更改生效firewall-cmd –reload               **这样可以让外部ip链接进来**

- 注意点2：配置文件将 bind 127.0.0.1 注释掉配置文件路径：/usr/local/redis-6.2.6/redies.conf

  **注释后允许所有网络接口（包括外网）访问。**

![image-20250628140339142](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628140339142.png)

kali链接redis

**ssh：**

SSH（Secure Shell）是一种用于远程连接到计算机和安全传输数据的协议。SSH通过加密通信来确保连接的安全性。SSH使用密钥对（公钥和私钥）来进行身份验证和加密通信。

**公钥：公钥通常存储在远程服务器上，以允许你通过SSH连接到该服务器。**

**私钥：私钥通常存储在你的本地计算机上，用于对SSH连接进行身份验证可以使用私钥对保存有公钥的远程服务器进行无需密码的远程登录，这个就是写入SSH公钥getshell的原理。**

所以我们要做的就是在kali中生成密钥对，将公钥通过远程Redis服务写入到目标主机的/**root/.ssh**目录下的

**authorized_keys**文件中

![image-20250628140610593](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628140610593.png)

攻击机生成密钥对   **ssh-keygen -t rsa**

![image-20250628140703869](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628140703869.png)

放到/home/kali/.ssh/  cd过去

![image-20250628140807062](C:\Users\hsx1231ol\AppData\Roaming\Typora\typora-user-images\image-20250628140807062.png)

**ls id_rsa   id_rsa.pub写入**

